name: Flutter Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# IMPORTANT: Permissions ilaina ho an'ny GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout ny code
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    # Step 2: Setup Java (ilaina ho an'ny Android build)
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    # Step 3: Setup Flutter SDK
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
    
    # Step 4: Verify Flutter installation
    - name: ðŸ” Verify Flutter
      run: |
        flutter --version
        flutter doctor -v
    
    # Step 5: Get dependencies
    - name: ðŸ“¦ Install dependencies
      run: flutter pub get
    
    # Step 6: Analyze code
    - name: ðŸ”¬ Analyze code
      run: flutter analyze
      continue-on-error: true
    
    # Step 7: Run tests (raha misy)
    - name: ðŸ§ª Run tests
      run: flutter test
      continue-on-error: true
    
    # Step 8: Build Web - MISY BASE-HREF MARINA!
    - name: ðŸŒ Build Web
      run: |
        flutter config --enable-web
        # BUILD MISY BASE-HREF izay mifanaraka amin'ny GitHub Pages URL
        flutter build web --release --web-renderer html --base-href "/${{ github.event.repository.name }}/"
        
        echo "âœ… Web built with base-href: /${{ github.event.repository.name }}/"
    
    # Step 9: Prepare for GitHub Pages
    - name: ðŸ“ Prepare GitHub Pages
      run: |
        # Manamarina ny build
        echo "ðŸ“¦ Web build contents:"
        ls -la build/web/
        
        # .nojekyll file (ilaina ho an'ny GitHub Pages mba tsy handany ny _files)
        touch build/web/.nojekyll
        
        # Verify index.html
        if [ -f build/web/index.html ]; then
          echo "âœ… index.html found"
          echo ""
          echo "ðŸ” Checking base href in index.html:"
          grep -o 'href="[^"]*"' build/web/index.html | head -5
        else
          echo "âŒ index.html NOT found!"
          exit 1
        fi
        
        # Affiche taille du build
        echo ""
        echo "ðŸ“Š Build size:"
        du -sh build/web/
    
    # Step 10: Deploy to GitHub Pages - MISY FORCE ORPHAN!
    - name: ðŸš€ Deploy to GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/web
        publish_branch: gh-pages
        force_orphan: true  # IMPORTANT: Mandefa vaovao foana tsy mitahiry history
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ðŸš€ Deploy: ${{ github.event.head_commit.message }}'
    
    # Step 11: Display deployment info
    - name: ðŸ“¢ Deployment Info
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "=========================================="
        echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
        echo "=========================================="
        echo ""
        echo "ðŸŒ Live URL:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "â±ï¸  Live site will update in 30-60 seconds"
        echo ""
        echo "ðŸ’¡ TIP: Force refresh (Ctrl+Shift+R or Cmd+Shift+R)"
        echo "      to clear browser cache if changes don't appear"
        echo "=========================================="
    
    # Step 12: Build Android APK
    - name: ðŸ“± Build Android APK
      run: flutter build apk --release --split-per-abi
    
    # Step 13: Upload APK artifacts
    - name: â¬†ï¸ Upload APK (arm64-v8a)
      uses: actions/upload-artifact@v4
      with:
        name: snake-game-arm64-v8a
        path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
        retention-days: 30
    
    - name: â¬†ï¸ Upload APK (armeabi-v7a)
      uses: actions/upload-artifact@v4
      with:
        name: snake-game-armeabi-v7a
        path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
        retention-days: 30
    
    - name: â¬†ï¸ Upload APK (x86_64)
      uses: actions/upload-artifact@v4
      with:
        name: snake-game-x86_64
        path: build/app/outputs/flutter-apk/app-x86_64-release.apk
        retention-days: 30
    
    # Step 14: Create build summary
    - name: ðŸ“‹ Build Summary
      run: |
        echo "## ðŸŽ® Snake Game - Deployment Success!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Status:** Deployed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¦ **Flutter:** $(flutter --version | head -n 1)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Commit:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Live Demo" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **[â–¶ï¸ PLAY NOW](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)** ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> ðŸ’¡ If you don't see changes, force refresh: **Ctrl+Shift+R** (Windows/Linux) or **Cmd+Shift+R** (Mac)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Android APK" >> $GITHUB_STEP_SUMMARY
        echo "Download from the **Artifacts** section below:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¥ **arm64-v8a** - Modern phones (Recommended)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¥ **armeabi-v7a** - Older devices" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¥ **x86_64** - Emulators only" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ¤– *Auto-deployed by GitHub Actions*" >> $GITHUB_STEP_SUMMARY